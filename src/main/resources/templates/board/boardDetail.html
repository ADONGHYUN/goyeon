<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</title>
    <!--<link href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">-->
    <link rel="stylesheet" href="/css/board/boardDetail.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
</head>
<body>
	<th:block th:replace="~{module/cnav}"></th:block>
	<th:block th:replace="~{module/csidenav}"></th:block>

    <div class="container-board">
        <div class="details">
            <div id="postHead" style="display: flex; align-items: center;">
                <div class="text-details" style="flex: 1;">
                    <p><strong>ì‘ì„±ì:</strong> <span th:text="${board.uid}"></span></p>
                    <p><strong>ì œëª©:</strong> <span th:text="${board.title}"></span></p>
                    <p><strong>ë¶€ì œëª©:</strong> <span th:text="${board.subtitle}"></span></p>
                </div>
                <div class="image mb-3" th:if="${board.bimage}" style="margin-left: 20px;">
                    <img th:src="@{/resources/Thumbnail/{bimage}(bimage=${board.bimage})}" 
                         th:alt="${board.title}" style="max-width: 150px; height: auto;">
                </div>
            </div>

            <hr>
            <div id="detailContent"><strong>ë‚´ìš©:</strong> <span th:utext="${board.content}"></span></div>
            <p><strong>ì‘ì„±ì¼:</strong> <span th:text="${#temporals.format(board.created_at, 'yyyy-MM-dd HH:mm')}"></span></p>
            <p><strong>ìˆ˜ì •ì¼:</strong> <span th:text="${#temporals.format(board.updated_at, 'yyyy-MM-dd HH:mm')}"></span></p>
        </div>

        <div class="actions mb-3">
            <a th:href="@{/board/update/{bnum}(bnum=${board.bnum})}" class="btn btn-primary">ìˆ˜ì •</a>
            <button class="btn btn-danger" th:onclick="'deletePost(' + ${board.bnum} + ')'">ì‚­ì œ</button>
        </div>

        <div class="back-link mb-3">
            <a href="javascript:history.back()" class="btn btn-secondary">ë’¤ë¡œê°€ê¸°</a>
        </div>

        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
        <div class="comments">
            <h2>ëŒ“ê¸€</h2>
            <div class="comment-form mb-4">
                <textarea id="comment-content" class="form-control" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                <button id="submit-comment" class="btn btn-primary mt-2">ëŒ“ê¸€ ë‹¬ê¸°</button>
            </div>

            <ul class="list-unstyled comment-list">
                <li th:each="rep : ${reply}" th:if="${rep.parentReplyId == null}" class="mb-3">
                    <div class="card">
                        <div class="card-body">
                            <p><strong th:text="${rep.uid}"></strong></p>
                            <p th:text="${rep.content}"></p>
                            <div class="vote-buttons">
                                <button class="btn btn-outline-success upvote" th:classappend="${rep.upvoteId.contains(session.userId) ? 'active' : ''}" th:data-rid="${rep.rid}">
                                    ğŸ‘ <span class="vote-count" th:text="${rep.replyUpvoteCount}">0</span>
                                </button>
                                <button class="btn btn-outline-danger downvote" th:classappend="${rep.downvoteId.contains(session.userId) ? 'active' : ''}" th:data-rid="${rep.rid}">
                                    ğŸ‘ <span class="vote-count" th:text="${rep.replyDownvoteCount}">0</span>
                                </button>
                            </div>
                            <div class="mb-3">
                                <textarea class="form-control comment-rereply" placeholder="ë‹µê¸€ ì…ë ¥"></textarea>
                                <button class="btn btn-secondary mt-2 submit-rereply" th:data-rid="${rep.rid}">ë‹µê¸€</button>
                            </div>

                            <!-- ë‹µê¸€ ë¦¬ìŠ¤íŠ¸ -->
                            <ul class="list-unstyled ps-3 rereply-list" th:data-parent-id="${rep.rid}">
                                <li th:each="rerep : ${reply}" th:if="${rerep.parentReplyId == rep.rid}" class="mb-2">
                                    <div class="card">
                                        <div class="card-body">
                                            <p><strong th:text="${rerep.uid}"></strong></p>
                                            <p th:text="${rerep.content}"></p>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
	<script th:inline="javascript">
	        // ëŒ“ê¸€ì„ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
	        function addComment(bnum, commentContent) {
	            $.ajax({
	                url: '/reply/writeReply',
	                type: 'POST',
	                data: {
	                    content: commentContent,
	                    bnum: bnum
	                },
	                success: function(response) {
	                    var newComment = `
	                        <li class="mb-3">
	                            <div class="card">
	                                <div class="card-body">
	                                    <p class="card-text"><strong>${response.author}</strong></p>
	                                    <p class="card-text">${response.content}</p>
	                                    <div class="vote-buttons">
	                                        <button class="btn btn-outline-success upvote" data-rid="${response.rid}">ğŸ‘<span class="vote-count">${response.replyUpvoteCount}</span></button>
	                                        <button class="btn btn-outline-danger downvote" data-rid="${response.rid}">ğŸ‘<span class="vote-count">${response.replyDownvoteCount}</span></button>
	                                    </div>       
	                                    <div class="mb-3">
	                                        <textarea class="form-control comment-rereply" placeholder="ë‹µê¸€ ì…ë ¥"></textarea>
	                                        <button class="btn btn-secondary mt-2 submit-rereply" data-rid="${response.rid}">ë‹µê¸€</button>
	                                    </div>
	                                    <ul class="list-unstyled ps-3 rereply-list" data-parent-id="${response.rid}"></ul>
	                                </div>
	                            </div>
	                        </li>`;
	                    $('.comment-list').prepend(newComment);
	                    $('#comment-content').val('');
	                },
	                error: function(xhr, status, error) {
	                    alert('ëŒ“ê¸€ì„ ì¶”ê°€í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
	                }
	            });
	        }

	        // ëŒ“ê¸€ ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
	        $('#submit-comment').click(function() {
	            var commentContent = $('#comment-content').val();
	            var bnum = /*[[${board.bnum}]]*/ 'default';

	            if (commentContent.trim() !== '') {
	                addComment(bnum, commentContent);
	            } else {
	                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
	            }
	        });

	        // ë‹µê¸€ì„ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
	        function addrereply(bnum, rereplyContent, parentReplyId) {
	            $.ajax({
	                url: '/reply/writeRereply',
	                type: 'POST',
	                data: {
	                    content: rereplyContent,
	                    bnum: bnum,
	                    parentReplyId: parentReplyId
	                },
	                success: function(response) {
	                    var newReply = `
	                        <li class="mb-2">
	                            <div class="card">
	                                <div class="card-body">
	                                    <p class="card-text"><strong>${response.author}</strong></p>
	                                    <p class="card-text">${response.content}</p>
	                                </div>
	                            </div>
	                        </li>`;
	                    
	                    $(`ul.rereply-list[data-parent-id="${parentReplyId}"]`).prepend(newReply);
	                    $(`button[data-rid="${parentReplyId}"]`).siblings('textarea').val('');
	                },
	                error: function(xhr, status, error) {
	                    alert('ë‹µê¸€ì„ ì¶”ê°€í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
	                }
	            });
	        }

	        // ë™ì  ë‹µê¸€ ë‹¬ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
	        $(document).on('click', '.submit-rereply', function() {
	            var rereplyContent = $(this).siblings('textarea').val();
	            var bnum = /*[[${board.bnum}]]*/ 'default';
	            var parentReplyId = $(this).data('rid');
	            
	            if (rereplyContent.trim() !== '') {
	                addrereply(bnum, rereplyContent, parentReplyId);
	            } else {
	                alert('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
	            }
	        });

	        // íˆ¬í‘œ í•¨ìˆ˜
	        function handleVote(rid, voteType, upButtonActive, downButtonActive) {
	            var url = "/reply/vote";
	            $.ajax({
	                url: url,
	                type: 'POST',
	                data: {
	                    rid: rid,
	                    voteType: voteType,
	                    upButtonActive: upButtonActive,
	                    downButtonActive: downButtonActive
	                },
	                success: function(response) {
	                    var upButton = $(`button.upvote[data-rid="${rid}"]`);
	                    var downButton = $(`button.downvote[data-rid="${rid}"]`);
	                    var upvoteCountElement = upButton.find('.vote-count');
	                    var downvoteCountElement = downButton.find('.vote-count');
	                    var upvoteCount = parseInt(upvoteCountElement.text());
	                    var downvoteCount = parseInt(downvoteCountElement.text());

	                    switch (response.result) {
	                        case 'upRemove':
	                            upButton.removeClass('active');
	                            upvoteCount -= 1;
	                            break;
	                        case 'downToUp':
	                            downButton.removeClass('active');
	                            upButton.addClass('active');
	                            downvoteCount -= 1;
	                            upvoteCount += 1;
	                            break;
	                        case 'up':
	                            upButton.addClass('active');
	                            upvoteCount += 1;
	                            break;
	                        case 'downRemove':
	                            downButton.removeClass('active');
	                            downvoteCount -= 1;
	                            break;
	                        case 'upToDown':
	                            upButton.removeClass('active');
	                            downButton.addClass('active');
	                            upvoteCount -= 1;
	                            downvoteCount += 1;
	                            break;
	                        case 'down':
	                            downButton.addClass('active');
	                            downvoteCount += 1;
	                            break;
	                        case 'invalidVote':
	                            alert('ì˜ëª»ëœ íˆ¬í‘œ ìœ í˜•ì…ë‹ˆë‹¤.');
	                            return;
	                        default:
	                            alert('ì•Œ ìˆ˜ ì—†ëŠ” ì‘ë‹µ ê²°ê³¼ì…ë‹ˆë‹¤.');
	                            return;
	                    }

	                    upvoteCountElement.text(upvoteCount);
	                    downvoteCountElement.text(downvoteCount);
	                },
	                error: function(xhr, status, error) {
	                    alert('íˆ¬í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
	                }   
	            });
	        }

	        // íˆ¬í‘œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
	        $(document).on('click', '.upvote, .downvote', function() {
	            var button = $(this);
	            var rid = button.data('rid');
	            var upButton = $(`button.upvote[data-rid="${rid}"]`);
	            var downButton = $(`button.downvote[data-rid="${rid}"]`);
	            var upButtonActive = upButton.hasClass('active');
	            var downButtonActive = downButton.hasClass('active');
	            var voteType = button.hasClass('upvote') ? 'upvote' : 'downvote';

	            handleVote(rid, voteType, upButtonActive, downButtonActive);
	        });

	        // ê²Œì‹œê¸€ ì‚­ì œ í•¨ìˆ˜
	        function deletePost(bnum) {
	            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
	                return;
	            }

	            $.ajax({
	                url: '/board/delete/bnum/' + bnum,
	                type: 'DELETE',
	                success: function(response) {
	                    alert("ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
	                    window.location.href = document.referrer;
	                },
	                error: function(xhr, status, error) {
	                    alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
	                }
	            });
	        }

	</script>

</body>
</html>
