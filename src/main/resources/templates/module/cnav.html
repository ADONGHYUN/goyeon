<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" th:href="@{/css/cnav.css}">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


	<title>고연</title>
</head>

<body>
	<header>
		<nav class="navbar navbar-expand-lg navbar-light">
			<div id="header" class="container-fluid">
				<a class="navbar-brand ms-0 logo" th:href="@{/}"> 고연 </a>
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav ms-auto">
						<!-- 로그인 상태일 때 보여줄 메뉴 -->

						<!-- 알림 버튼 -->
						<li class="nav-item login-only me-3" style="display: none; position: relative;">
							<button id="notificationButton" class="btn btn-link position-relative">
								🔔
							</button>
							<div id="notificationDropdown">
								<ul id="notificationItems">
									<li>알림이 없습니다.</li>
								</ul>
							</div>
						</li>

						<li class="nav-item login-only" style="display: none;">
							<a class="nav-link mx-5" href="/user/myinfo">내정보</a>
						</li>
						<li class="nav-item login-only" style="display: none;">
							<a class="nav-link mx-5" href="/logout">로그아웃</a>
						</li>

						<!-- 비로그인 상태일 때 보여줄 메뉴 -->
						<li class="nav-item logout-only" style="display: none;">
							<a class="nav-link mx-5" href="/login">로그인</a>
						</li>
						<li class="nav-item logout-only" style="display: none;">
							<a class="nav-link mx-5" href="/user/join">회원가입</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>
	</header>

	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const token = localStorage.getItem('accessToken');

			if (token) {
				// 로그인 상태
				document.querySelectorAll('.login-only').forEach(el => el.style.display = 'block');
			} else {
				// 비로그인 상태
				document.querySelectorAll('.logout-only').forEach(el => el.style.display = 'block');
			}

			document.querySelectorAll('a[href="/logout"]').forEach(link => {
				link.addEventListener('click', function (e) {
					e.preventDefault();
					localStorage.removeItem('accessToken');
					window.location.href = '/';
				});
			});

			$.ajax({
				url: '/notification/unreadNotiCount',
				method: 'GET',
				headers: {
					'Authorization': 'Bearer ' + token
				},
				success: function (count) {
					$('#notificationButton .badge').remove(); // 기존 badge 삭제
					if (count > 9) {
						$('#notificationButton').append(`<span class="badge bg-danger position-absolute top-0 start-100 translate-middle">9+</span>`);
					} else if (count > 0) {
						$('#notificationButton').append(`<span class="badge bg-danger position-absolute top-0 start-100 translate-middle">${count}</span>`);
					}
				}
			});

			$('#notificationButton').click(function () {
				$('#notificationDropdown').toggle();

				$.ajax({
					url: '/notification/list',
					method: 'GET',
					headers: {
						'Authorization': 'Bearer ' + token
					},
					success: function (data) {
						const list = $('#notificationItems');
						list.empty();

						let unreadCount = 0;

						if (data.length === 0) {
							list.append('<li>알림이 없습니다.</li>');
						} else {
							data.forEach(function (noti) {
								const li = $('<li></li>');
								const link = $('<a></a>')
									.text(noti.message)
									.attr('href', '#') // 실제 이동 방지
									.click(function (e) {
										e.preventDefault();
										$.ajax({
											url: '/notification/read/' + noti.id,
											method: 'POST',
											headers: {
												'Authorization': 'Bearer ' + token
											},
											success: function () {
												if (noti.link) {
													window.location.href = noti.link;
												} else {
													alert('알림이 읽음 처리되었습니다.');
												}
											},
											error: function () {
												alert('알림 읽음 처리 실패');
											}
										});
									});

								li.append(link);
								list.append(li);
							});

						}
					},
					error: function () {
						$('#notificationItems').html('<li>알림 불러오기 실패</li>');
					}
				});
			});

			// 바깥 클릭 시 드롭다운 닫기
			$(document).click(function (e) {
				if (!$(e.target).closest('#notificationButton, #notificationDropdown').length) {
					$('#notificationDropdown').hide();
				}
			});
		});
	</script>

</body>

</html>