<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" th:href="@{/css/cnav.css}">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


	<title>ê³ ì—°</title>
</head>

<body>
	<header>
		<nav class="navbar navbar-expand-lg navbar-light">
			<div id="header" class="container-fluid">
				<a class="navbar-brand ms-0 logo" th:href="@{/}"> ê³ ì—° </a>
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav ms-auto">
						<!-- ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ ë³´ì—¬ì¤„ ë©”ë‰´ -->

						<!-- ì•Œë¦¼ ë²„íŠ¼ -->
						<li class="nav-item login-only me-3" style="display: none; position: relative;">
							<button id="notificationButton" class="btn btn-link position-relative">
								ğŸ””
							</button>
							<div id="notificationDropdown">
								<ul id="notificationItems">
									<li>ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>
								</ul>
							</div>
						</li>

						<li class="nav-item login-only" style="display: none;">
							<a class="nav-link mx-5" href="/user/myinfo">ë‚´ì •ë³´</a>
						</li>
						<li class="nav-item login-only" style="display: none;">
							<a class="nav-link mx-5" href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
						</li>

						<!-- ë¹„ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ ë³´ì—¬ì¤„ ë©”ë‰´ -->
						<li class="nav-item logout-only" style="display: none;">
							<a class="nav-link mx-5" href="/login">ë¡œê·¸ì¸</a>
						</li>
						<li class="nav-item logout-only" style="display: none;">
							<a class="nav-link mx-5" href="/user/join">íšŒì›ê°€ì…</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>
	</header>

	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const token = localStorage.getItem('accessToken');

			if (token) {
				// ë¡œê·¸ì¸ ìƒíƒœ
				document.querySelectorAll('.login-only').forEach(el => el.style.display = 'block');
			} else {
				// ë¹„ë¡œê·¸ì¸ ìƒíƒœ
				document.querySelectorAll('.logout-only').forEach(el => el.style.display = 'block');
			}

			document.querySelectorAll('a[href="/logout"]').forEach(link => {
				link.addEventListener('click', function (e) {
					e.preventDefault();
					localStorage.removeItem('accessToken');
					window.location.href = '/';
				});
			});

			$.ajax({
				url: '/notification/unreadNotiCount',
				method: 'GET',
				headers: {
					'Authorization': 'Bearer ' + token
				},
				success: function (count) {
					$('#notificationButton .badge').remove(); // ê¸°ì¡´ badge ì‚­ì œ
					if (count > 9) {
						$('#notificationButton').append(`<span class="badge bg-danger position-absolute top-0 start-100 translate-middle">9+</span>`);
					} else if (count > 0) {
						$('#notificationButton').append(`<span class="badge bg-danger position-absolute top-0 start-100 translate-middle">${count}</span>`);
					}
				}
			});

			$('#notificationButton').click(function () {
				$('#notificationDropdown').toggle();

				$.ajax({
					url: '/notification/list',
					method: 'GET',
					headers: {
						'Authorization': 'Bearer ' + token
					},
					success: function (data) {
						const list = $('#notificationItems');
						list.empty();

						let unreadCount = 0;

						if (data.length === 0) {
							list.append('<li>ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>');
						} else {
							data.forEach(function (noti) {
								const li = $('<li></li>');
								const link = $('<a></a>')
									.text(noti.message)
									.attr('href', '#') // ì‹¤ì œ ì´ë™ ë°©ì§€
									.click(function (e) {
										e.preventDefault();
										$.ajax({
											url: '/notification/read/' + noti.id,
											method: 'POST',
											headers: {
												'Authorization': 'Bearer ' + token
											},
											success: function () {
												if (noti.link) {
													window.location.href = noti.link;
												} else {
													alert('ì•Œë¦¼ì´ ì½ìŒ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
												}
											},
											error: function () {
												alert('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨');
											}
										});
									});

								li.append(link);
								list.append(li);
							});

						}
					},
					error: function () {
						$('#notificationItems').html('<li>ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</li>');
					}
				});
			});

			// ë°”ê¹¥ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
			$(document).click(function (e) {
				if (!$(e.target).closest('#notificationButton, #notificationDropdown').length) {
					$('#notificationDropdown').hide();
				}
			});
		});
	</script>

</body>

</html>